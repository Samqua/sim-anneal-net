# -*- coding: utf-8 -*-
"""
Created on Thu Jan  4 15:58:41 2018

@author: Samqua
@version: 1.1

Computes the distance matrix on N nodes, where distance_matrix[i][j] is the distance between i to j.
The distance is not merely Euclidean, but the arc length along a surface denoted sym_ter(x,y).
The distance curves are currently not geodesics, but will be at some point in the future.

"""
#####################################################

#import random
#import numpy as np
#import matplotlib.pyplot as plt
#import plotly as py
#from plotly.graph_objs import *
#import networkx as nx
import copy
import datetime
#import math
import sympy
from sympy.functions import exp
import scipy.integrate

#####################################################

start=datetime.datetime.now()
print("START: "+str(start))

# specify the initial coordinates of the points
# the following is a 400 node lattice with small deviations to prevent any two distances from being the same
init_coord=[[25.22173574682489, 25.463809368645595], [25.356713292891666, 74.83725580051876], [24.892213503771497, 124.67083825351833], [24.811647594631143, 174.64604203342483], [25.45398151014866, 225.48764068404535], [25.226518053591708, 274.62630654483064], [24.948537830756624, 325.37899766193016], [24.91579403642254, 374.66085315701696], [24.701731216279942, 425.3906278854898], [24.91032962992619, 475.0020908345029], [24.60513345039995, 525.0589521777797], [25.291405976303178, 574.8143689756926], [25.246014813089406, 624.7565346333216], [24.58031838095356, 674.7552311489709], [24.690890570102205, 725.353294696176], [24.5661399389239, 774.7830014936335], [24.821713681594595, 824.9141909230813], [24.81135002858323, 874.7744334077302], [25.031673198096257, 925.2015193182126], [24.58509731969619, 975.3240550834599], [75.29291207966929, 24.963801724608274], [74.91371571384957, 74.76855745843982], [74.56174398967536, 124.84192306467487], [74.5878452519763, 175.11295424860614], [74.73198064894723, 224.93487307867755], [74.51908852434022, 275.36686596134047], [75.11920941136651, 325.07384612762064], [75.34517319049799, 375.1607750974445], [74.50412954627096, 424.6104695358243], [74.83554581844577, 475.48730405550975], [75.31470926459079, 525.4366306002124], [75.46200201005882, 574.7224478183089], [74.8576203699997, 624.9178715594367], [74.89162063161972, 674.8860414081184], [74.58763837109097, 724.7260373580666], [74.62322782554631, 775.1637281900815], [75.0235059212356, 824.7004029843818], [74.99681569934408, 874.8177593274598], [74.98038849183246, 925.0969047036738], [75.14095912950899, 974.6990864729124], [125.49896281893699, 25.479363029875365], [124.60733701949195, 75.03213097781304], [125.47209407574826, 125.35506718810619], [124.57741119773767, 174.97181708015844], [124.74617490292398, 224.66955117902216], [125.33195219491489, 274.80554455209125], [124.55937205053468, 325.1926042599181], [125.09237913253274, 375.08481987707484], [124.96078521862249, 425.2394651854618], [125.1176924610521, 474.64817994588896], [125.35033156495778, 525.0924615451343], [125.19645821851623, 575.1522943254282], [124.83901903013843, 624.7148266778291], [124.54053530915691, 675.2082397721832], [125.07546813617925, 725.2911847711348], [124.51964866741214, 775.0460528057722], [125.13157510412819, 824.6954014939324], [124.85109276115212, 875.4463614511626], [124.91753728280469, 924.6116679388821], [124.61343662460227, 975.1548752702622], [174.73025678396965, 24.734379093250194], [175.27541459298158, 75.30920237666552], [175.47945732536618, 124.56120071916158], [174.6893493996542, 175.06810902023233], [175.19977813293494, 224.53165936620192], [174.7918508430009, 274.86486010058866], [174.534917373338, 324.8594864665508], [175.29751813408373, 375.16028131881603], [175.45299656717685, 424.5804233073762], [174.9235642067736, 474.9840598870729], [175.28631553805002, 524.9673758240554], [175.00830122972553, 574.769060279196], [175.47055770614986, 625.0501412949727], [175.02401150414985, 675.2018117641899], [175.18797620229503, 724.6251011347117], [174.64287795827622, 774.8721779874259], [175.33740173039953, 825.3865198043278], [175.19270203042132, 875.1286618078999], [175.36258135369863, 924.6838574494259], [175.0454319387316, 974.7235543159052], [224.89890028699747, 24.7932088434314], [225.4785143287615, 74.84151608823294], [224.8730526276709, 124.51566854774084], [225.1694089081329, 175.49774608793444], [225.47699219388545, 225.30905823694053], [225.4850754518799, 274.8608183360454], [224.97031444835469, 325.19086594064396], [224.9324988793668, 375.471056580706], [224.9139161446461, 424.8096567763937], [224.9610921249474, 475.256734783218], [224.6614951688734, 524.8406788471691], [225.14801769073694, 574.8652292687261], [224.61117324428676, 625.211861039207], [224.89935801633408, 675.4470998065608], [224.89494325669432, 724.843302811099], [224.974694019871, 774.6663696794246], [225.42198009028922, 825.1357623101999], [224.5548358110346, 875.1685416626973], [225.14570714300908, 925.1016104335127], [224.8628502862838, 975.0788678999836], [275.43977010566687, 25.16431417543172], [274.9588055876721, 74.57937671255324], [274.98220229037486, 124.73693520822303], [274.5369429172954, 175.0871707336096], [275.4318993551509, 225.3848424131377], [275.4643178386915, 275.0063708823576], [275.2803645718344, 324.65277263942755], [275.4943353516222, 374.5646528976965], [275.1923220213403, 424.90960987407874], [275.4435482920484, 475.0765874519434], [275.2843140041215, 524.8537692749135], [275.13938356920914, 574.86420543055], [274.739738326441, 624.694286559392], [274.5487391140793, 674.9972948790843], [274.79688720857365, 725.2664782650407], [275.4040072091619, 775.0777104812626], [275.31500579980565, 824.687790974129], [274.72647374446564, 874.5131709712309], [274.7371814300488, 924.5158636366003], [275.49806129364265, 975.301673473436], [325.43564485403357, 24.71751801361085], [324.820637753944, 74.74866980155036], [324.93167276974253, 124.6967741902894], [325.26621478330986, 174.7017288065786], [325.4639060459976, 224.77509082667868], [325.1040705103259, 275.452949499526], [324.6759090369384, 324.9385869482005], [324.93672501204514, 375.4191232434991], [325.1788557768187, 425.3626798408572], [325.08164064411244, 475.2716717870967], [324.890943157399, 525.0887931717294], [324.50364468736126, 575.0495619031917], [324.58731013973426, 624.9860975434991], [325.2707213151024, 674.6261902650347], [324.9678756456709, 725.0063456222791], [325.1230328162406, 774.6943003319567], [324.6748220763052, 825.2361175605946], [325.389717157951, 874.7919739255099], [325.10860722112716, 925.0147980764556], [324.5424931680603, 975.1629449238508], [374.9980777492393, 25.02330125838945], [374.8398354932948, 75.36495535883736], [375.1396300908857, 124.67442662048677], [375.36870789830573, 174.6651757746743], [375.3686095127379, 225.25627669706142], [374.77304959613946, 275.06553074650964], [374.9188652888338, 325.0061914888165], [375.2262043500919, 375.4121802558824], [375.0573531550958, 425.27813472420274], [374.6791212762847, 474.53157693189064], [375.38737020986946, 525.361705297491], [374.81991076525, 575.1525833026532], [375.4808562344056, 625.3041572789837], [374.8089657173525, 675.2427921272805], [375.2889861714166, 724.7966745379687], [374.85307336096406, 774.725593765989], [374.8777795294723, 825.1922156632888], [375.09954204086847, 875.212157980501], [374.8674543430284, 924.5109947502913], [374.7800724209502, 974.9843845268505], [424.9633023306885, 25.274382847656998], [424.60705108250863, 75.42896480364358], [425.41754771286594, 125.14002810702566], [425.4003288834556, 175.13401619692283], [425.14345770845426, 225.43320863140985], [424.6749167901532, 275.4545025745285], [424.57132783094045, 325.42732195805064], [424.998557792809, 374.9730095755551], [424.7154313922029, 424.6233182047299], [424.94525527479703, 474.96743717992126], [425.1890760377331, 524.575518370311], [425.29985013611997, 574.8496674793394], [425.43837789622887, 624.7013850105608], [425.1517323680886, 675.0804422666191], [425.4673408994603, 725.3814427586026], [424.6980395283281, 774.6029259647995], [425.1676408143417, 825.049449196625], [425.37955296316966, 874.52440258732], [425.35689928269414, 924.5020132111797], [425.1034439653591, 974.6662211156349], [474.7961141389807, 24.694876607028903], [474.66064495654166, 75.08786428785034], [474.6130090502883, 124.72356951924073], [475.22558605511193, 174.8120103413434], [475.1112178121486, 225.44296432081583], [475.19546085958217, 275.1522246633256], [474.63936578343214, 325.12111909940813], [474.7386855196997, 375.15957231477836], [475.43793625298093, 424.7162637066156], [474.83561850121805, 475.0174716267201], [474.9984568314222, 524.905550122818], [474.55003540678246, 575.3440069779095], [475.44481354663066, 625.0677822441269], [474.7750830601687, 675.310627747463], [474.760434994197, 725.4150838590367], [475.3733031345301, 775.2508273635586], [474.9826618016925, 824.8438626801025], [474.75337610427573, 874.7516576819703], [475.37426353868733, 925.3446414610074], [474.7298164190886, 974.5351478653445], [524.741080359376, 25.142236338431005], [524.6483397649813, 74.80209843602469], [525.4610257667018, 125.41198000909795], [525.4619559224157, 175.0798294309298], [524.8915343835544, 224.55773363643576], [525.2189367483511, 274.9056182029403], [524.9132174392612, 325.4283840398868], [524.652354928355, 374.794560809213], [525.0035090537211, 424.95970586347875], [525.0234605493335, 475.3316255713205], [524.5324449501616, 525.0394048183002], [524.6234198581253, 575.1583489844487], [525.3586278127636, 625.4484246966999], [524.7691153658822, 675.4031735956918], [524.6682043695575, 724.850976562736], [524.7093450408844, 775.4404396537607], [525.284256965101, 825.4493450529137], [524.6859473722203, 875.4311957756624], [524.7413565475698, 925.2777007122492], [525.314596278287, 974.59283616583], [575.0341008712916, 25.030040763590588], [575.4950918569778, 74.716455229533], [574.8793204849884, 125.02522659914352], [575.4774573985552, 175.0894901591627], [575.4538649448261, 225.22722383384675], [575.2033370105137, 275.3006984727992], [575.2875176243102, 325.3963796689785], [574.7372040061515, 374.9717831332006], [575.359945758738, 425.272661411719], [575.0422079744425, 475.00171437799986], [574.8371222050273, 525.4323184061745], [574.8885512979954, 574.653515768411], [574.8053107838707, 625.186193107076], [574.7733804172487, 675.3506412613921], [575.2204524017944, 725.0464968738781], [575.0699409944104, 775.131743598644], [574.8431241914913, 825.1603981958025], [574.6785226955279, 875.4673573222236], [575.2880518886227, 924.6129667454395], [574.9879337979811, 974.8233784533634], [625.3928201338871, 25.46769039441792], [624.6284708452362, 75.40675468370628], [624.8976729120617, 125.17913324055783], [625.2215741287149, 174.6219011033989], [625.1867147685512, 225.43583467451845], [625.0807597610439, 274.85207104503064], [624.5622453990818, 325.4147040535186], [624.7460012320594, 374.6212657304104], [625.2165862151107, 425.20583896278555], [625.1460484569485, 474.5624241990072], [624.8182925997294, 524.8048857447575], [625.4454356815476, 575.4254338556409], [625.0394202058748, 624.9459988193806], [624.6249070549594, 675.29025208469], [624.918426814446, 724.5046379442995], [625.1068667225767, 774.9889074350494], [624.6956384001389, 825.0458916714789], [625.4317007425274, 874.6360002296859], [625.4815387280244, 924.8812336827142], [624.9308001090562, 974.5463481525113], [674.9031149256699, 24.74135059593801], [675.2476049698046, 74.80802186198896], [675.4420003071604, 125.36157577210288], [675.2162647868041, 174.823930971281], [675.4781006739812, 225.12267833327536], [675.0330082280377, 275.35767264847135], [675.2359741487188, 325.19698366910677], [675.281949692665, 374.9928314828463], [674.779895446207, 424.9446055884793], [674.6631601031927, 474.713484814796], [674.9861933243383, 524.6051060443824], [674.5057842728575, 574.5269789757031], [674.6646625446009, 624.7458769742672], [674.5328079130211, 674.504355856878], [674.622222207789, 725.3259761086638], [675.0600576287334, 774.5537427090273], [675.2288826894686, 824.7773378062608], [675.2884189325778, 875.4873050495261], [675.3167886314772, 924.8482850828814], [674.6462888132081, 975.3224091981801], [724.749896424005, 25.30884768334455], [725.4509369837712, 75.44855745219537], [724.7083347409326, 124.7123487136112], [724.7701995595208, 174.57807854748742], [725.3360975526984, 225.09214369286804], [725.0160335869597, 274.92369561122445], [725.4277334939545, 325.1001002070306], [725.0776015024985, 374.9451894149131], [724.7998494591885, 424.9539548175486], [724.8294182026817, 474.55608892821164], [724.8824229461472, 524.7390611743807], [725.4830856492401, 574.6145573869984], [725.4451533099722, 624.826428361211], [725.1783534084234, 674.7072384093901], [725.0263965312109, 724.9560803901776], [724.6985316879831, 774.7139994391749], [725.4410510930728, 825.3990959741521], [724.6422123388288, 874.7419859781113], [724.8410743403133, 924.7050183850492], [725.2252195826458, 975.0721435666392], [774.609587430243, 24.626055414302353], [774.7159352817866, 74.88264341095767], [775.2223678227082, 124.73395322909194], [774.8187389798285, 175.48448945603548], [775.3053058316882, 225.13668964947723], [774.8447658703294, 275.0819846670216], [775.1732577661448, 324.56086059706666], [774.8432246353568, 374.9726130561991], [774.8401728039463, 425.136625279819], [774.5081951016798, 474.82968451527904], [775.4903028434001, 524.89707125926], [774.5477144040826, 575.3286478911589], [775.1602730179396, 624.6111768363946], [775.3813629443489, 675.2059828133139], [774.9398907369672, 725.4722432905745], [775.4356221889718, 774.8754716192874], [775.1996390728704, 825.0287197898615], [775.2626242389612, 874.6835072812529], [774.744458973241, 925.3581645261365], [774.7751263699397, 975.200860372573], [824.5172760056138, 24.5858139791716], [824.9790888265269, 75.36763666045867], [824.7352841209702, 124.7046901405534], [825.4565877649025, 174.9271613045764], [824.8607446652283, 224.65297045121085], [825.2346180900767, 275.4487549267311], [825.2775434497279, 324.5481843738095], [825.2514541071623, 375.31280882383453], [824.7748947412917, 425.2073123799024], [824.9043237425685, 474.86346105065354], [824.7572032087318, 525.3015358682582], [824.9622563428109, 575.3371768319232], [824.5940165638407, 625.1898519962131], [824.6826136191775, 675.3340236844957], [824.6709897789461, 725.1194573287349], [825.1706977006659, 774.733863222275], [824.9019594739249, 824.984854974012], [824.9286118894179, 875.2941093679266], [825.480051714489, 924.9053933435524], [824.6232732013603, 974.512909777905], [875.2300150039254, 25.033067256409275], [875.0216719200629, 75.00034727406717], [875.2607148845834, 125.33175438769835], [874.7332795599707, 175.28089206829853], [874.5151808291779, 224.8562701632245], [874.5943219110727, 274.6331880279434], [875.2028218442089, 325.26016309446067], [875.3786420030523, 375.1152853678626], [875.3210154484912, 425.1632187582995], [875.1158871385727, 475.1451209451323], [875.2872381255813, 524.643452950711], [874.8962445299004, 575.2089209329457], [874.8655680366522, 624.9703658958425], [875.3882889098794, 674.7339764728902], [875.03226356975, 724.9280646894738], [874.629012161176, 774.920054117312], [874.9982404038185, 825.1702180447911], [875.0044297185019, 874.7094632740254], [874.8133210609894, 924.5846105676638], [875.1162887827395, 975.4630124874543], [924.5980926554207, 25.10007160939597], [925.2996998447788, 75.33143490591021], [925.1561188470436, 125.16457296914314], [925.4913952836217, 175.12930302748467], [925.0486977970759, 224.76432093814216], [925.1305384362923, 274.53759591822126], [924.6204030629603, 324.65192146487453], [925.1459524007167, 375.2573209467501], [925.1301301418124, 425.12092210614327], [924.8350674503578, 475.2584663642923], [924.6305538866021, 524.789090948842], [924.9405494551651, 574.6445537189817], [925.1997815722335, 624.7246796355533], [925.2510208999818, 675.362713867698], [924.518551513542, 725.4924675284755], [924.5419560313222, 774.9496252364082], [924.9221974842271, 825.2388018038495], [924.9379951757033, 874.5310514809564], [925.3629283578343, 925.0364944009151], [925.0455809213004, 975.0923570526475], [974.8049856710614, 24.63095271706985], [974.7328855369541, 74.70902716257811], [974.8557899123368, 124.65414825073775], [975.2081876711571, 174.71868887489677], [974.8493336278893, 225.42579065982164], [975.4800042551568, 275.2031733513638], [974.7930626020219, 324.71632603454333], [974.850733823989, 375.04009136792996], [974.8400447525302, 424.87689828224916], [974.5005030671468, 474.51568095484396], [974.6954313804621, 524.884944043211], [974.9311387189381, 574.5383780925666], [975.4627712156037, 625.2022235306865], [974.7173607120908, 674.8006700462353], [975.3489966839404, 725.2598347408184], [974.50111450393, 775.4164477189987], [974.550795479997, 824.9018013233884], [974.7533424974229, 875.3517850592859], [974.875666812499, 925.3535127158159], [975.4782202270345, 975.3542393971596]]

N=len(init_coord) # took me about 40 minutes to compute the distance matrix of the above coordinates

def dot(u,v): # returns inner product of vectors (i.e. lists) u and v
        if len(u)!=len(v):
                return 0
        else:
                return sum(i[0]*i[1] for i in zip(u,v))

def sym_ter(x,y):
        return 500*exp(-(((x-500)**2) + ((y-500)**2))/40000) # gaussian "mountain"

def distance(x0,y0,x1,y1):
        x=sympy.Symbol('x')
        y=sympy.Symbol('y')
        t=sympy.Symbol('t')
        
        Tx=[sympy.diff(x,x),sympy.diff(y,x),sympy.diff(sym_ter(x,y),x)]
        Ty=[sympy.diff(x,y),sympy.diff(y,y),sympy.diff(sym_ter(x,y),y)]
        c1=dot(Tx,Tx)
        c2=dot(Tx,Ty)
        c3=dot(Ty,Ty)
        c1=c1.subs(x,(1-t)*x0+t*x1)
        c1=c1.subs(y,(1-t)*y0+t*y1)
        c2=c2.subs(x,(1-t)*x0+t*x1)
        c2=c2.subs(y,(1-t)*y0+t*y1)
        c3=c3.subs(x,(1-t)*x0+t*x1)
        c3=c3.subs(y,(1-t)*y0+t*y1)
        
        c1num=sympy.utilities.lambdify([t],c1) # these are FUNCTIONS of the parameter t
        c2num=sympy.utilities.lambdify([t],c2)
        c3num=sympy.utilities.lambdify([t],c3)
        
        result = scipy.integrate.quad(lambda t: (c1num(t)*(x1-x0)**2 + 2*c2num(t)*(x1-x0)*(y1-y0) + c3num(t)*(y1-y0)**2)**0.5,0,1)
        return result[0]

#####################################################

distance_matrix = [[0 for col in range(N)] for row in range(N)] # initialize distance matrix
from_bottom_left = [0] * N

for i in range(0,N):
        from_bottom_left[i] = init_coord[i][0]+init_coord[i][1]
    
nodes = {} #intialize labels

for i in range(0, N):
        nodes[i]=copy.deepcopy(init_coord[from_bottom_left.index(sorted(from_bottom_left)[i])]) # n.b. these are static labels and will not change from here on out

for i in range(0,N):
        for j in range(0,N):
                if i==j:
                        distance_matrix[i][j]=0 # this prevents the distance algorithm from attempting a numerical integration on the same point
                elif distance_matrix[j][i]!=0:
                        distance_matrix[i][j]=distance_matrix[j][i] # symmetry halves the computation time
                else:
                        distance_matrix[i][j]=distance(nodes[i][0],nodes[i][1],nodes[j][0],nodes[j][1]) #create symmetric distance matrix where (i,j) is the distance from j to i. note zeros along the main diagonal

f = open('distance_matrix.py', 'w')
f.write("distance_matrix="+str(distance_matrix))
f.close()

print("END: "+str(datetime.datetime.now()))
print("RUN TIME: "+str(datetime.datetime.now()-start))
